<!DOCTYPE html>

<html lang="ko">
  <head>
    <link href="styles/theme-colors.css" rel="stylesheet" />
    <link rel="stylesheet" href="styles/layout.css" />
    <link rel="stylesheet" href="styles/visuals-shared.css" />

    <link href="styles/mypage.css" rel="stylesheet" />
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>TaxSonic | 마이페이지</title>
  </head>
  <body>
    <!-- Slide Menu -->
    <button aria-label="메뉴 열기" id="hamburgerBtn" type="button">☰</button>
    <div aria-hidden="true" id="drawerBackdrop"></div>
    <aside aria-label="슬라이드 메뉴" id="drawer">
      <div class="drawerHead">
        <div class="drawerTitle">메뉴</div>
        <button class="drawerClose" id="drawerClose" type="button">닫기</button>
      </div>
      <div class="drawerNav">
        <div class="drawerGroup">
          <div class="drawerGroupTitle">기본</div>
          <a href="service_main.html">메인</a>
          <a href="onboarding.html">이용 가이드</a>
          <a href="login.html">로그인</a>
        </div>
        <div class="drawerGroup">
          <div class="drawerGroupTitle">계산</div>
          <a href="quick_calc.html">간편 계산</a>
          <a href="detail_income.html">상세 계산</a>
        </div>
        <div class="drawerGroup">
          <div class="drawerGroupTitle">고객센터</div>
          <a href="board_qna.html">Q&amp;A</a>
          <a href="board_faq.html">FAQ</a>
        </div>
        <div class="drawerGroup" data-user-only="true">
          <div class="drawerGroupTitle">내 정보</div>
          <a href="mypage.html">마이페이지</a>
          <a href="member_history.html">기록 열람</a>
        </div>
        <div class="drawerGroup" data-admin-only="true">
          <div class="drawerGroupTitle">관리자</div>
          <a href="admin_tax_rates.html">세율/정책</a>
          <a href="admin_deduction_items.html">공제 항목</a>
          <a href="admin_analytics.html">로그 분석</a>
        </div>
      </div>
    </aside>
    <header>
      <div class="container header-inner">
        <div class="logo"><a href="service_main.html">TaxSonic</a></div>
        <nav>
          <a class="" href="onboarding.html">이용 가이드</a>
          <a class="" href="quick_calc.html">간편 계산</a>
          <a class="" href="detail_income.html">상세 계산</a>
          <a class="" href="board_qna.html">Q&amp;A</a>
          <a class="" href="board_faq.html">FAQ</a>
          <a class="active" href="mypage.html">마이페이지</a>
          <a href="login.html">로그아웃</a>
        </nav>
      </div>
    </header>
    <main class="container">
      <div class="h1">마이페이지</div>
      <p class="p">회원정보 수정과 탈퇴를 관리합니다.</p>
      <div class="grid grid-2">
        <div class="surface">
          <div class="h2" style="font-size: 22px">내 계정</div>
          <div class="field">
            <label>비밀번호</label>
            <div
              class="notice"
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 12px;
                flex-wrap: wrap;
              "
            >
              <div>
                <div style="font-weight: 600">
                  보안을 위해 주기적으로 변경을 권장합니다.
                </div>
                <div class="muted">최근 변경일: 2026-01-01 (데모)</div>
              </div>
              <div style="display: flex; gap: 10px; flex-wrap: wrap">
                <a
                  class="btn-primary btn-small"
                  href="mypage_password_edit.html"
                  >비밀번호 수정</a
                >
              </div>
            </div>
          </div>
          <div class="hr"></div>
          <div class="h3">기록 열람</div>
          <p class="p" style="margin-bottom: 12px">
            연말 정산 결과 내용을 PDF파일로 다시 받거나
            <br />
            EMAIL로 보내고 싶으신 분은 밑의 버튼을 눌러주세요
          </p>
          <a
            class="btn-primary"
            href="member_history.html"
            style="width: 100%; justify-content: center"
            >기록 열람 바로가기</a
          >
          <div class="hr"></div>
          <div class="h3" style="color: var(--ts-color-06)">회원 탈퇴</div>
          <p class="muted" style="margin: 0 0 12px">
            탈퇴 시 회원 정보 및 기록이 삭제될 수 있습니다. (실서비스 정책에
            맞게 조정)
          </p>
          <a
            class="btn-danger"
            href="mypage_withdraw.html"
            style="width: 100%; display: inline-flex; justify-content: center"
            >회원 탈퇴 진행</a
          >
        </div>
        <!-- Right: Record Analytics (like result page "분석 그래프") -->
        <div class="surface">
          <div class="h2" style="font-size: 22px">기록 분석</div>
          <p class="p" style="margin-bottom: 12px">
            년도별 계산 기록을 요약해 그래프로 보여줍니다. (데모 데이터)
          </p>
          <div aria-label="년도 선택" class="tabs" id="yearTabs">
            <button class="tab active" data-year="2026" type="button">
              2026
            </button>
            <button class="tab" data-year="2025" type="button">2025</button>
            <button class="tab" data-year="2024" type="button">2024</button>
          </div>
          <div class="hr"></div>
          <div aria-label="요약 지표" class="kpiGrid">
            <div class="kpiBox">
              <div class="num" id="kpiSessions">-</div>
              <div class="label">계산 횟수</div>
            </div>
            <div class="kpiBox">
              <div class="num" id="kpiRefund">-</div>
              <div class="label">연간 총 환급(예상)</div>
            </div>
          </div>
          <div class="muted" style="margin-top: 10px">
            ※ 실제 서비스에서는 회원 기록 데이터를 기반으로 표시됩니다.
          </div>
          <div class="hr"></div>
          <div class="h3">항목별 기여도</div>
          <div class="muted" style="margin-bottom: 10px">
            최종 결과 페이지의 분석 그래프처럼, 항목별 공제/감면 기여도를 막대로
            표시합니다.
          </div>
          <div class="barList" id="barList">
            <div class="barRow">
              <div
                class="muted"
                style="display: flex; justify-content: space-between; gap: 10px"
              >
                <span>소득공제</span><span id="pctIncome">0%</span>
              </div>
              <div class="barTrack">
                <div class="barFill" id="barIncome"></div>
              </div>
            </div>
            <div class="barRow">
              <div
                class="muted"
                style="display: flex; justify-content: space-between; gap: 10px"
              >
                <span>세액공제</span><span id="pctTax">0%</span>
              </div>
              <div class="barTrack">
                <div class="barFill" id="barTax"></div>
              </div>
            </div>
            <div class="barRow">
              <div
                class="muted"
                style="display: flex; justify-content: space-between; gap: 10px"
              >
                <span>감면</span><span id="pctRelief">0%</span>
              </div>
              <div class="barTrack">
                <div class="barFill" id="barRelief"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <footer class="footer">© 2026 TaxSonic. All rights reserved.</footer>
    <script>
      (function () {
        const btn = document.getElementById("hamburgerBtn");
        const drawer = document.getElementById("drawer");
        const backdrop = document.getElementById("drawerBackdrop");
        const closeBtn = document.getElementById("drawerClose");

        function open() {
          drawer && drawer.classList.add("open");
          backdrop && backdrop.classList.add("open");
        }
        function close() {
          drawer && drawer.classList.remove("open");
          backdrop && backdrop.classList.remove("open");
        }
        btn && btn.addEventListener("click", open);
        closeBtn && closeBtn.addEventListener("click", close);
        backdrop && backdrop.addEventListener("click", close);
        // ===== Active highlight (drawer + header nav) =====
        const current = (location.pathname.split("/").pop() || "index.html")
          .split("?")[0]
          .split("#")[0];
        const allLinks = document.querySelectorAll("#drawer .drawerNav a");
        allLinks.forEach((a) => {
          const href = (a.getAttribute("href") || "").trim();
          if (href && href === current) {
            a.classList.add("active");
          }
        });
        const topNavLinks = document.querySelectorAll("header nav a");
        topNavLinks.forEach((a) => {
          const href = (a.getAttribute("href") || "").trim();
          if (href && href === current) {
            a.classList.add("active");
          }
        });

        // ===== Admin visibility (role-based, no toggle) =====
        function getUserRole() {
          const role =
            localStorage.getItem("taxsonic_user_role") ||
            localStorage.getItem("taxsonic_role") ||
            localStorage.getItem("role") ||
            "";
          return String(role).toLowerCase();
        }
        function isLoggedIn() {
          const v =
            localStorage.getItem("taxsonic_is_logged_in") ||
            localStorage.getItem("taxsonic_logged_in") ||
            localStorage.getItem("is_logged_in") ||
            "";
          const hasToken = !!(
            localStorage.getItem("taxsonic_token") ||
            localStorage.getItem("auth_token") ||
            localStorage.getItem("access_token")
          );
          const hasUser = !!(
            localStorage.getItem("taxsonic_user_id") ||
            localStorage.getItem("user_id") ||
            localStorage.getItem("username")
          );
          // If role is set, treat as logged-in for this static prototype.
          const role = getUserRole();
          return (
            v === "1" ||
            v === "true" ||
            hasToken ||
            hasUser ||
            role === "admin" ||
            role === "user"
          );
        }
        function getIsAdmin() {
          const role = getUserRole();
          const legacy = localStorage.getItem("taxsonic_is_admin") === "1"; // backward compat for older builds
          return role === "admin" || legacy;
        }
        function applyAdminVisibility() {
          const showAdmin = isLoggedIn() && getIsAdmin();
          document
            .querySelectorAll('[data-admin-only="true"]')
            .forEach((el) => {
              el.style.display = showAdmin ? "" : "none";
            });
        }
        applyAdminVisibility();

        // ===== User-only visibility (logged-in user only; admin 제외) =====
        function applyUserVisibility() {
          const role = getUserRole();
          const showUser = isLoggedIn() && role === "user";
          document.querySelectorAll('[data-user-only="true"]').forEach((el) => {
            el.style.display = showUser ? "" : "none";
          });
        }
        applyUserVisibility(); // ===== Accordion groups =====
        function setCollapsed(group, collapsed) {
          if (!group) return;
          group.classList.toggle("is-collapsed", !!collapsed);
          const title = group.querySelector(".drawerGroupTitle");
          if (title) {
            title.setAttribute("aria-expanded", collapsed ? "false" : "true");
          }
        }

        const groups = Array.from(
          document.querySelectorAll("#drawer .drawerGroup")
        );
        groups.forEach((group) => {
          const title = group.querySelector(".drawerGroupTitle");
          if (!title) return;

          const name = title.textContent.trim();
          const key = "taxsonic_drawer_group_" + name;

          // make title behave like a button
          title.setAttribute("role", "button");
          title.setAttribute("tabindex", "0");

          const saved = localStorage.getItem(key);
          if (saved === "1") setCollapsed(group, true);

          const toggle = () => {
            const collapsed = group.classList.contains("is-collapsed");
            const next = !collapsed;
            setCollapsed(group, next);
            localStorage.setItem(key, next ? "1" : "0");
          };

          title.addEventListener("click", toggle);
          title.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              toggle();
            }
          });
        });

        // Ensure active link's group is open
        const active = document.querySelector("#drawer .drawerNav a.active");
        if (active) {
          const group = active.closest(".drawerGroup");
          if (group) {
            setCollapsed(group, false);
            const title = group.querySelector(".drawerGroupTitle");
            if (title) {
              const key = "taxsonic_drawer_group_" + title.textContent.trim();
              localStorage.setItem(key, "0");
            }
          }
        }
      })();
    </script>
    <script>
      // === MyPage record analytics demo ===
      (function () {
        const yearData = {
          2026: {
            sessions: 6,
            totalRefund: 420000,
            bars: { income: 55, tax: 35, relief: 20 },
            months: [
              18000, 26000, 12000, 48000, 30000, 0, 52000, 41000, 17000, 28000,
              21000, 32000,
            ],
          },
          2025: {
            sessions: 4,
            totalRefund: 310000,
            bars: { income: 48, tax: 32, relief: 18 },
            months: [
              12000, 8000, 15000, 30000, 0, 42000, 25000, 19000, 36000, 28000,
              15000, 0,
            ],
          },
          2024: {
            sessions: 3,
            totalRefund: 190000,
            bars: { income: 40, tax: 25, relief: 15 },
            months: [
              0, 14000, 22000, 0, 18000, 26000, 0, 11000, 30000, 22000, 0,
              16000,
            ],
          },
        };

        const fmtWon = (n) => (n || 0).toLocaleString("ko-KR") + "원";

        const els = {
          tabs: document.getElementById("yearTabs"),
          kpiSessions: document.getElementById("kpiSessions"),
          kpiRefund: document.getElementById("kpiRefund"),
          barIncome: document.getElementById("barIncome"),
          barTax: document.getElementById("barTax"),
          barRelief: document.getElementById("barRelief"),
          pctIncome: document.getElementById("pctIncome"),
          pctTax: document.getElementById("pctTax"),
          pctRelief: document.getElementById("pctRelief"),
          monthBars: document.getElementById("monthBars"),
        };

        function renderMonths(values) {
          if (!els.monthBars) return;
          els.monthBars.innerHTML = "";
          const max = Math.max(1, ...values);
          const labels = [
            "1월",
            "2월",
            "3월",
            "4월",
            "5월",
            "6월",
            "7월",
            "8월",
            "9월",
            "10월",
            "11월",
            "12월",
          ];
          values.forEach((v, i) => {
            const wrap = document.createElement("div");
            wrap.className = "miniBarWrap";
            const bar = document.createElement("div");
            bar.className = "miniBar";
            const h = Math.max(6, Math.round((v / max) * 100));
            bar.style.height = h + "%";
            bar.title = labels[i] + ": " + fmtWon(v);
            const label = document.createElement("div");
            label.className = "miniBarLabel";
            label.textContent = i + 1;
            wrap.appendChild(bar);
            wrap.appendChild(label);
            els.monthBars.appendChild(wrap);
          });
        }

        function setYear(year) {
          const d = yearData[year];
          if (!d) return;

          // tabs
          const buttons = els.tabs
            ? els.tabs.querySelectorAll("[data-year]")
            : [];
          buttons.forEach((b) =>
            b.classList.toggle(
              "active",
              String(b.dataset.year) === String(year)
            )
          );

          // kpi
          if (els.kpiSessions)
            els.kpiSessions.textContent = (d.sessions || 0) + "회";
          if (els.kpiRefund) els.kpiRefund.textContent = fmtWon(d.totalRefund);

          // bars
          const income = Math.max(0, Math.min(100, d.bars.income || 0));
          const tax = Math.max(0, Math.min(100, d.bars.tax || 0));
          const relief = Math.max(0, Math.min(100, d.bars.relief || 0));
          if (els.barIncome) els.barIncome.style.width = income + "%";
          if (els.barTax) els.barTax.style.width = tax + "%";
          if (els.barRelief) els.barRelief.style.width = relief + "%";
          if (els.pctIncome) els.pctIncome.textContent = income + "%";
          if (els.pctTax) els.pctTax.textContent = tax + "%";
          if (els.pctRelief) els.pctRelief.textContent = relief + "%";

          renderMonths(d.months || []);
        }

        // events
        els.tabs &&
          els.tabs.addEventListener("click", (e) => {
            const btn = e.target.closest("[data-year]");
            if (!btn) return;
            setYear(btn.dataset.year);
          });

        // init
        setYear("2026");
      })();
    </script>
    <script>
      (function () {
        function isLoggedIn() {
          return localStorage.getItem("taxsonic_is_logged_in") === "1";
        }
        function clearAuth() {
          localStorage.removeItem("taxsonic_is_logged_in");
          localStorage.removeItem("taxsonic_user_role");
          localStorage.removeItem("taxsonic_role");
          localStorage.removeItem("role");
          localStorage.removeItem("taxsonic_is_admin"); // legacy
        }

        function enhanceLoginLogoutLinks() {
          const links = Array.from(
            document.querySelectorAll(
              'a[href="login.html"], a[href="./login.html"]'
            )
          );
          if (!links.length) return;

          if (isLoggedIn()) {
            links.forEach((a) => {
              a.setAttribute("href", "#logout");
              a.textContent = "로그아웃";
              a.classList.add("logoutLink");
            });
            document.addEventListener("click", function (e) {
              const a = e.target.closest('a[href="#logout"]');
              if (!a) return;
              e.preventDefault();
              clearAuth();
              window.location.href = "index.html";
            });
          } else {
            links.forEach((a) => {
              a.textContent = "로그인";
              // keep href as login.html
            });
          }
        }

        document.addEventListener("DOMContentLoaded", enhanceLoginLogoutLinks);
      })();
    </script>
  </body>
</html>
