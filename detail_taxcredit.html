<!DOCTYPE html>

<html lang="ko">
  <head>
    <link href="styles/theme-colors.css" rel="stylesheet" />
    <link href="styles/layout.css" rel="stylesheet" />
    <link href="styles/detail_taxcredit.css" rel="stylesheet" />
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <title>TaxSonic | 상세계산 - 세액공제</title>
  </head>
  <body>
    <!-- Slide Menu -->
    <button aria-label="메뉴 열기" id="hamburgerBtn" type="button">☰</button>
    <div aria-hidden="true" id="drawerBackdrop"></div>
    <aside aria-label="슬라이드 메뉴" id="drawer">
      <div class="drawerHead">
        <div class="drawerTitle">메뉴</div>
        <button class="drawerClose" id="drawerClose" type="button">닫기</button>
      </div>
      <div class="drawerNav">
        <div class="drawerGroup">
          <div class="drawerGroupTitle">기본</div>
          <a href="service_main.html">메인</a>
          <a href="onboarding.html">이용 가이드</a>
          <a href="login.html">로그인</a>
        </div>
        <div class="drawerGroup">
          <div class="drawerGroupTitle">계산</div>
          <a href="quick_calc.html">간편 계산</a>
          <a href="detail_income.html">상세 계산</a>
        </div>
        <div class="drawerGroup">
          <div class="drawerGroupTitle">고객센터</div>
          <a href="board_qna.html">Q&amp;A</a>
          <a href="board_faq.html">FAQ</a>
        </div>
        <div class="drawerGroup" data-user-only="true">
          <div class="drawerGroupTitle">내 정보</div>
          <a href="mypage.html">마이페이지</a>
          <a href="member_history.html">기록 열람</a>
        </div>
        <div class="drawerGroup" data-admin-only="true">
          <div class="drawerGroupTitle">관리자</div>
          <a href="admin_tax_rates.html">세율/정책</a>
          <a href="admin_deduction_items.html">공제 항목</a>
          <a href="admin_analytics.html">로그 분석</a>
        </div>
      </div>
    </aside>
    <header>
      <div class="container header-inner">
        <div class="logo"><a href="service_main.html">TaxSonic</a></div>
        <nav>
          <a class="" href="onboarding.html">이용 가이드</a>
          <a class="" href="quick_calc.html">간편 계산</a>
          <a class="active" href="detail_income.html">상세 계산</a>
          <a class="" href="board_qna.html">Q&amp;A</a>
          <a class="" href="board_faq.html">FAQ</a>
          <a class="" href="login.html">로그인</a>
        </nav>
      </div>
    </header>
    <main class="container">
      <div class="muted">STEP 2 / 2 · 세액공제</div>
      <div class="h1" style="font-size: 30px; margin-top: 8px">
        세액공제 입력
      </div>
      <p class="p">
        해당되는 항목만 입력해도 충분합니다. (연도별 세율/한도는 관리자 정책
        값으로 자동 적용)
      </p>
      <div class="grid grid-2">
        <div class="card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <div class="h3">중소기업 취업자 감면</div>
            <button
              class="btn-ghost btn-small"
              onclick="openHelp('sme')"
              type="button"
            >
              ⓘ
            </button>
          </div>
          <p class="p">해당 여부를 체크하면 연도별 감면율/한도가 적용됩니다.</p>
          <label
            ><input
              style="width: auto; margin-right: 8px"
              type="checkbox"
            />해당됨</label
          >
        </div>
        <div class="card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <div class="h3">월세</div>
            <button
              class="btn-ghost btn-small"
              onclick="openHelp('rent')"
              type="button"
            >
              ⓘ
            </button>
          </div>
          <p class="p">연간 월세 납부 금액</p>
          <div class="field">
            <label>납부 금액</label
            ><input id="money_" placeholder="예: 4800000" type="number" />
            <div class="btnRow" data-money-controls="1" style="margin-top: 8px">
              <button
                class="btn-outline btn-small"
                onclick="resetMoney(this)"
                type="button"
              >
                초기화
              </button>
              <button
                class="btn-outline btn-small"
                onclick="addMoney(this, 10000000)"
                type="button"
              >
                +1000만</button
              ><button
                class="btn-outline btn-small"
                onclick="addMoney(this, 5000000)"
                type="button"
              >
                +500만</button
              ><button
                class="btn-outline btn-small"
                onclick="addMoney(this, 1000000)"
                type="button"
              >
                +100만
              </button>
            </div>
          </div>
        </div>
        <div class="card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <div class="h3">의료비</div>
            <button
              class="btn-ghost btn-small"
              onclick="openHelp('medical')"
              type="button"
            >
              ⓘ
            </button>
          </div>
          <p class="p">본인/부양가족 의료비 지출</p>
          <div class="field">
            <label>의료비</label
            ><input id="money_" placeholder="예: 1200000" type="number" />
            <div class="btnRow" data-money-controls="1" style="margin-top: 8px">
              <button
                class="btn-outline btn-small"
                onclick="resetMoney(this)"
                type="button"
              >
                초기화
              </button>
              <button
                class="btn-outline btn-small"
                onclick="addMoney(this, 10000000)"
                type="button"
              >
                +1000만</button
              ><button
                class="btn-outline btn-small"
                onclick="addMoney(this, 5000000)"
                type="button"
              >
                +500만</button
              ><button
                class="btn-outline btn-small"
                onclick="addMoney(this, 1000000)"
                type="button"
              >
                +100만
              </button>
            </div>
          </div>
        </div>
        <div class="card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <div class="h3">IRP(퇴직연금)</div>
            <button
              class="btn-ghost btn-small"
              onclick="openHelp('irp')"
              type="button"
            >
              ⓘ
            </button>
          </div>
          <p class="p">IRP 납입 금액</p>
          <div class="field">
            <label>납입 금액</label
            ><input id="money_" placeholder="예: 3000000" type="number" />
            <div class="btnRow" data-money-controls="1" style="margin-top: 8px">
              <button
                class="btn-outline btn-small"
                onclick="resetMoney(this)"
                type="button"
              >
                초기화
              </button>
              <button
                class="btn-outline btn-small"
                onclick="addMoney(this, 10000000)"
                type="button"
              >
                +1000만</button
              ><button
                class="btn-outline btn-small"
                onclick="addMoney(this, 5000000)"
                type="button"
              >
                +500만</button
              ><button
                class="btn-outline btn-small"
                onclick="addMoney(this, 1000000)"
                type="button"
              >
                +100만
              </button>
            </div>
          </div>
        </div>
        <div class="card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <div class="h3">자녀 세액공제</div>
            <button
              class="btn-ghost btn-small"
              onclick="openHelp('child')"
              type="button"
            >
              ⓘ
            </button>
          </div>
          <p class="p">자녀 수에 따라 정액 공제가 적용됩니다.</p>
          <div class="field">
            <label>자녀 수</label
            ><input min="0" placeholder="예: 1" type="number" />
          </div>
        </div>
        <div class="card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <div class="h3">기부금</div>
            <button
              class="btn-ghost btn-small"
              onclick="openHelp('donation')"
              type="button"
            >
              ⓘ
            </button>
          </div>
          <p class="p">기부금은 구간별 세액공제가 적용될 수 있습니다.</p>
          <div class="field">
            <label>기부금</label
            ><input id="money_" placeholder="예: 500000" type="number" />
            <div class="btnRow" data-money-controls="1" style="margin-top: 8px">
              <button
                class="btn-outline btn-small"
                onclick="resetMoney(this)"
                type="button"
              >
                초기화
              </button>
              <button
                class="btn-outline btn-small"
                onclick="addMoney(this, 10000000)"
                type="button"
              >
                +1000만</button
              ><button
                class="btn-outline btn-small"
                onclick="addMoney(this, 5000000)"
                type="button"
              >
                +500만</button
              ><button
                class="btn-outline btn-small"
                onclick="addMoney(this, 1000000)"
                type="button"
              >
                +100만
              </button>
            </div>
          </div>
          <div class="field">
            <label>유형</label>
            <select>
              <option>일반</option>
              <option>법정</option>
              <option>지정</option>
            </select>
          </div>
        </div>
      </div>
      <div
        style="
          display: flex;
          justify-content: flex-end;
          gap: 10px;
          margin-top: 26px;
        "
      >
        <a class="btn-ghost" href="detail_income.html">이전: 소득공제</a>
        <a class="btn-primary" href="result_final.html">계산하고 결과 보기</a>
      </div>
    </main>
    <div
      id="modal"
      style="
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        align-items: center;
        justify-content: center;
        z-index: 1000;
      "
    >
      <div class="surface" style="max-width: 560px; width: 92%">
        <div class="h3" id="mTitle">도움말</div>
        <p class="p" id="mText" style="white-space: pre-line"></p>
        <div style="display: flex; justify-content: flex-end">
          <button class="btn-primary" onclick="closeModal()">확인</button>
        </div>
      </div>
    </div>
    <script>
      function openHelp(type) {
        const title = document.getElementById("mTitle");
        const text = document.getElementById("mText");
        const map = {
          sme: [
            "중소기업 취업자 감면",
            "해당 여부에 따라 연도별 감면율/한도(정책 값)가 적용됩니다.\n증빙은 재직/취업 확인 자료가 필요할 수 있습니다.",
          ],
          rent: [
            "월세 세액공제",
            "연간 월세 납부액에 공제율과 한도가 적용됩니다.\n계약서/이체내역 등 증빙이 필요할 수 있습니다.",
          ],
          medical: [
            "의료비 세액공제",
            "총급여 대비 일정 문턱(정책 값)을 초과한 의료비에 공제율이 적용될 수 있습니다.",
          ],
          irp: ["IRP 세액공제", "IRP 납입액에 공제율과 한도가 적용됩니다."],
          child: [
            "자녀 세액공제",
            "자녀 수 구간별 정액 공제(정책 값)가 적용됩니다.",
          ],
          donation: [
            "기부금 세액공제",
            "기부금은 구간별 공제율이 적용될 수 있으며, 연도별 한도/구간(정책 값)이 있습니다.",
          ],
        };
        title.innerText = map[type][0];
        text.innerText = map[type][1];
        document.getElementById("modal").style.display = "flex";
      }
      function closeModal() {
        document.getElementById("modal").style.display = "none";
      }
    </script>
    <footer class="footer">© 2026 TaxSonic. All rights reserved.</footer>
    <script>
      (function () {
        const btn = document.getElementById("hamburgerBtn");
        const drawer = document.getElementById("drawer");
        const backdrop = document.getElementById("drawerBackdrop");
        const closeBtn = document.getElementById("drawerClose");

        function open() {
          drawer && drawer.classList.add("open");
          backdrop && backdrop.classList.add("open");
        }
        function close() {
          drawer && drawer.classList.remove("open");
          backdrop && backdrop.classList.remove("open");
        }
        btn && btn.addEventListener("click", open);
        closeBtn && closeBtn.addEventListener("click", close);
        backdrop && backdrop.addEventListener("click", close);
        // ===== Active highlight (drawer + header nav) =====
        const current = (location.pathname.split("/").pop() || "index.html")
          .split("?")[0]
          .split("#")[0];
        const allLinks = document.querySelectorAll("#drawer .drawerNav a");
        allLinks.forEach((a) => {
          const href = (a.getAttribute("href") || "").trim();
          if (href && href === current) {
            a.classList.add("active");
          }
        });
        const topNavLinks = document.querySelectorAll("header nav a");
        topNavLinks.forEach((a) => {
          const href = (a.getAttribute("href") || "").trim();
          if (href && href === current) {
            a.classList.add("active");
          }
        });

        // ===== Admin visibility (role-based, no toggle) =====
        function getUserRole() {
          const role =
            localStorage.getItem("taxsonic_user_role") ||
            localStorage.getItem("taxsonic_role") ||
            localStorage.getItem("role") ||
            "";
          return String(role).toLowerCase();
        }
        function isLoggedIn() {
          const v =
            localStorage.getItem("taxsonic_is_logged_in") ||
            localStorage.getItem("taxsonic_logged_in") ||
            localStorage.getItem("is_logged_in") ||
            "";
          const hasToken = !!(
            localStorage.getItem("taxsonic_token") ||
            localStorage.getItem("auth_token") ||
            localStorage.getItem("access_token")
          );
          const hasUser = !!(
            localStorage.getItem("taxsonic_user_id") ||
            localStorage.getItem("user_id") ||
            localStorage.getItem("username")
          );
          // If role is set, treat as logged-in for this static prototype.
          const role = getUserRole();
          return (
            v === "1" ||
            v === "true" ||
            hasToken ||
            hasUser ||
            role === "admin" ||
            role === "user"
          );
        }
        function getIsAdmin() {
          const role = getUserRole();
          const legacy = localStorage.getItem("taxsonic_is_admin") === "1"; // backward compat for older builds
          return role === "admin" || legacy;
        }
        function applyAdminVisibility() {
          const showAdmin = isLoggedIn() && getIsAdmin();
          document
            .querySelectorAll('[data-admin-only="true"]')
            .forEach((el) => {
              el.style.display = showAdmin ? "" : "none";
            });
        }
        applyAdminVisibility();

        // ===== Accordion groups =====
        function setCollapsed(group, collapsed) {
          if (!group) return;
          group.classList.toggle("is-collapsed", !!collapsed);
          const title = group.querySelector(".drawerGroupTitle");
          if (title) {
            title.setAttribute("aria-expanded", collapsed ? "false" : "true");
          }
        }

        const groups = Array.from(
          document.querySelectorAll("#drawer .drawerGroup")
        );
        groups.forEach((group) => {
          const title = group.querySelector(".drawerGroupTitle");
          if (!title) return;

          const name = title.textContent.trim();
          const key = "taxsonic_drawer_group_" + name;

          // make title behave like a button
          title.setAttribute("role", "button");
          title.setAttribute("tabindex", "0");

          const saved = localStorage.getItem(key);
          if (saved === "1") setCollapsed(group, true);

          const toggle = () => {
            const collapsed = group.classList.contains("is-collapsed");
            const next = !collapsed;
            setCollapsed(group, next);
            localStorage.setItem(key, next ? "1" : "0");
          };

          title.addEventListener("click", toggle);
          title.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              toggle();
            }
          });
        });

        // Ensure active link's group is open
        const active = document.querySelector("#drawer .drawerNav a.active");
        if (active) {
          const group = active.closest(".drawerGroup");
          if (group) {
            setCollapsed(group, false);
            const title = group.querySelector(".drawerGroupTitle");
            if (title) {
              const key = "taxsonic_drawer_group_" + title.textContent.trim();
              localStorage.setItem(key, "0");
            }
          }
        }
      })();
    </script>
    <script>
      function getFieldInput(btn) {
        // 버튼이 들어있는 가장 가까운 field를 찾고, 그 안의 input을 찾음
        const field = btn.closest(".field");
        if (!field) return null;
        return field.querySelector("input");
      }

      function addMoney(btn, amount) {
        const el = getFieldInput(btn);
        if (!el) return;

        const cur =
          parseInt((el.value || "0").toString().replace(/[^0-9-]/g, ""), 10) ||
          0;

        el.value = cur + amount;
        el.dispatchEvent(new Event("input", { bubbles: true }));
      }

      function resetMoney(btn) {
        const el = getFieldInput(btn);
        if (!el) return;

        el.value = "";
        el.dispatchEvent(new Event("input", { bubbles: true }));
      }
    </script>
    <script>
      (function () {
        function isLoggedIn() {
          return localStorage.getItem("taxsonic_is_logged_in") === "1";
        }
        function clearAuth() {
          localStorage.removeItem("taxsonic_is_logged_in");
          localStorage.removeItem("taxsonic_user_role");
          localStorage.removeItem("taxsonic_role");
          localStorage.removeItem("role");
          localStorage.removeItem("taxsonic_is_admin"); // legacy
        }

        function enhanceLoginLogoutLinks() {
          const links = Array.from(
            document.querySelectorAll(
              'a[href="login.html"], a[href="./login.html"]'
            )
          );
          if (!links.length) return;

          if (isLoggedIn()) {
            links.forEach((a) => {
              a.setAttribute("href", "#logout");
              a.textContent = "로그아웃";
              a.classList.add("logoutLink");
            });
            document.addEventListener("click", function (e) {
              const a = e.target.closest('a[href="#logout"]');
              if (!a) return;
              e.preventDefault();
              clearAuth();
              window.location.href = "index.html";
            });
          } else {
            links.forEach((a) => {
              a.textContent = "로그인";
              // keep href as login.html
            });
          }
        }

        document.addEventListener("DOMContentLoaded", enhanceLoginLogoutLinks);
      })();
    </script>
  </body>
</html>
